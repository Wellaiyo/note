---
layout: post
title: 'Web渲染知多少'
date: 2016-01-17
---

几乎所有的前端er都在讨论关于web渲染方面的问题，所谓的web渲染问题其实就是让项目的性能更为强劲，这也是前端比较重要的一部分工作。

关于渲染，不同类型的项目解决办法都是不同的（讨论的基础不同）。

静态内容较多的展示性网站，比如公司官网、项目介绍网站，这类网站一般都很注重SEO，所以在考虑渲染问题的同时，要注意不能丢掉搜索引擎的友好度。

还有一类是系统平台，比如管理系统等操作比较频繁，交互性更强的网站。很大一部分系统平台是可以考虑忽视SEO的，数据更新快，数据量相对多很多。这个时候，性能是唯一的侧重点，所以开发者可以无顾忌的只管搞定性能问题。

说到项目的性能，就前端而言，问题一般都处于渲染方面。也就是从服务器端拿到请求后，在客户端响应出来的首页渲染速度有多快。最典型的例子就是淘宝等大型交互性强，数据量大的网站。其解决办法现在也比较通用，就是首屏服务器端渲染，次屏ajax渲染，按需加载。为什么这么做呢？道理很简单，论速度服务器端渲染比ajax快，ajax要修改DOM，造成重绘和重排，代价是比较大的。而且首屏的重要性是毋庸置疑的，如果第一屏都半天加载不出来，凭什么让用户相信你还是一个好的网站。

渲染，渲染，渲染到底是个啥？

渲染通俗来讲，就是指客户端从服务器拿到资源后，在浏览器生成页面的一个过程。这个过程是这样的：（请先脑补一个HTML源码的结构）

- html开头 -> css加载 -> html内容 -> js加载 -> ajax请求 -> 渲染内容

这是标准的ajax渲染方式，首屏加载的时候也就是上述过程的时间

- html开头 -> css加载 -> html内容 -> js加载

这是服务器端渲染的过程，首先这是两个比较极端的例子，都是纯ajax或者纯服务器端渲染的方式。可以看出单从步骤上来看服务器端渲染要少些，但如果你要这么算的话，那就有点走进误区的感觉了，因为虽然步骤名都一样，其内容渲染这块的内质确实完全不同的。ajax只是将html内容中纯静态的架子搭建出来，而服务器端渲染是将数据绑定到了模板引擎上渲染出来的。

所以才会有开头所说的，项目类型不同，讨论的基础也就不同。数据量少，无疑服务器端渲染是最合适的，而大量的数据的话，ajax按需加载的优势就出来了。而且比较浅显的一种前后端分离的理论就是建立在渲染是纯ajax的基础上（前后端分离的好处这里就不多说了），当然如果数据量少的项目，也根本不需要前后端分离这个概念。

ok，说了这么多，渲染的大致知识也就差不多了解了，关键点在于项目的特点，根据项目的特点来制定解决办法永远都是最好的方式。

那么接下来详细的看下首屏加载时间上的几个点。html开头和css加载这里没什么说的了，css加载并没有其他的处理方式，只能是压缩压缩再压缩了，纯静态的html内容，DOM树构建是蛮快的这边不与考虑。[React](https://facebook.github.io/react/)的虚拟DOM很有意思，也有很多人说性能很好，可以看看。接来下也就是js加载了，首先肯定是想到了

	加载时间 = 加载结束 - 加载开始

一个坑马上要出来了，因为你潜意识下就忽视了js的执行时间，特别是频繁的DOM操作，都是比较费时间的，这个执行的时间有时甚至会达到几百毫秒。那么仅仅是这样吗？我们知道“加载是并行的，而执行是串行的”，html开始加载的时候，浏览器会将页面外联的css文件和js文件并行加载，如果一个文件还没回来，它后面的代码就不会执行。也就是说，如果加载时某个css文件滞后了，那么js的执行时间也会被滞后。

所以说，css文件内联其实是有莫大好处的，这也就解释了为什么我会在一些大公司的网站是看到html源码中有一大堆css。这个可以用相应的构建工具帮忙处理的，为了不让css文件的阻塞影响后面js代码的执行。

根据上述我们马上就能理解了，为什么公共库、交互操作等跟渲染无关的js文件都在前面加载，而js渲染的文件要放在后面加载。还有就是，负责渲染的js后面还外联着其它的js文件并将其阻塞，这时候渲染相关的js不管是动态拉取新的js文件，还是拉取渲染相关的内容都一切正常，页面内容都被顺利渲染出来，因为它们的执行并不需要等待被阻塞的文件加载完。

根据这些知识，我们可以制定相应的策略：

1. “无关紧要”的js文件不要放在渲染js文件的前面，“无关紧要”指的是与首屏渲染无关，而将渲染相关的js文件放在最前面，而且我们知道原生js的执行速度比js框架的执行速度要快得多，所以可以考虑渲染js用原生写。

2. 动态加载的js的执行不受html后面的外联js的阻塞的影响，也就是说它的执行和后面js的执行顺序是不确定的，所以要小心处理好文件的依赖关系。也可以是这样：负责动态加载js的文件时html里面外联的最后一个文件。

想要了解更多，可以看看大公司网站html源码都是怎么编写的，这里面很多细节就是这篇文章所讲述的知识的应用。

再回到ajax渲染和服务器端渲染方案的选择，就一般开发情况来说，我个人比较偏向服务器端渲染和ajax渲染联合使用。各有好处，那就取一个平衡点。
